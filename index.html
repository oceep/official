<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oceep by FoxAI</title>
    <!-- Tích hợp Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tích hợp Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
      MathJax = {
        tex: {
          inlineMath: [['\\(', '\\)']],
          displayMath: [['\\[', '\\]']]
        }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        
        /* Ẩn thanh cuộn cho Chrome, Safari và Opera */
       .hide-scrollbar {
          overflow-y: auto; /* Ensures content remains scrollable */
          scrollbar-width: none; /* For Firefox */
          -ms-overflow-style: none; /* For Internet Explorer and Edge */
        }

        .hide-scrollbar::-webkit-scrollbar {
          display: none; /* For Chrome, Safari, and Opera */
        }
        .sidebar-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Lớp phủ cho hình nền, áp dụng cho background container */
        #background-container.image-overlay::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* <!-- MODIFICATION: Enhanced Animations --> */

        /* Enhanced Modal Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0) scale(1); }
            to { opacity: 0; transform: translateY(10px) scale(0.98); }
        }
        .modal-fade-enter { animation: fadeIn 0.3s ease-out; }
        .modal-fade-leave { animation: fadeOut 0.3s ease-in; }

        /* Staggered Entrance Animation */
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-up {
            animation: fadeUp 0.6s ease-out forwards;
        }

        /* AI Message Pop-in Animation */
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            80% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop-in {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            transform-origin: bottom left; /* Origin for AI messages */
        }
        .user-message .animate-pop-in {
            transform-origin: bottom right; /* Origin for user messages */
        }

         /* Typing indicator */
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: #9E9EA1;
            display: inline-block;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-of-type(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-of-type(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        /* Con trỏ gõ chữ kiểu "I" mảnh */
        .streaming::after {
            content: '';
            display: inline-block;
            width: 0;
            height: 1em;
            border-right: 2px solid;
            margin-left: 3px;
            vertical-align: text-bottom;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        /* Button Interaction Animation */
        .btn-interaction {
            transition: transform 0.15s ease, box-shadow 0.2s ease;
        }
        .btn-interaction:hover {
            transform: scale(1.05);
        }
        .btn-interaction:active {
            transform: scale(0.95);
            transition-duration: 0.05s;
        }
        /* <!-- MODIFICATION END --> */
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden transition-colors duration-500">
    <!-- Container cho hình nền cố định -->
    <div id="background-container" class="fixed inset-0 -z-10 transition-all duration-500 bg-cover bg-center"></div><!-- Giao diện chính của ứng dụng -->
<div id="app-container" class="flex h-full"><!-- Sidebar -->
<aside id="sidebar" class="w-64 bg-black/10 dark:bg-black/30 backdrop-blur-lg flex flex-col transition-all duration-300 -translate-x-full absolute lg:relative lg:translate-x-0 z-30 h-full hidden">
    <div class="p-4 flex justify-between items-center border-b border-white/10">
        <h2 id="sidebar-header" class="font-bold text-lg">Lịch sử Chat</h2>
    </div>
    <div id="history-list" class="flex-grow overflow-y-auto sidebar-scroll p-2 space-y-1">
        <!-- Lịch sử sẽ được thêm vào đây bằng JS -->
    </div>
</aside>
        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col h-full">
            <header class="p-4 flex justify-between items-center z-10">
                 <div class="flex items-center gap-4">
                    <div id="header-title" class="flex items-center text-xl font-semibold">
                        <svg id="original-icon" width="28" height="28" viewBox="0 0 100 100">
                            <defs>
                                <radialGradient id="bubbleGradient" cx="0.3" cy="0.3" r="0.7">
                                    <stop id="gradStop1" offset="0%" style="stop-color:rgb(220,240,255);stop-opacity:1" />
                                    <stop id="gradStop2" offset="100%" style="stop-color:rgb(51, 149, 240);stop-opacity:1" />
                                </radialGradient>
                            </defs>
                            <circle cx="50" cy="50" r="45" fill="url(#bubbleGradient)" stroke="rgba(255,255,255,0.7)" stroke-width="3"/>
                            <path d="M 35 30 A 25 25 0 0 1 60 55" fill="none" stroke="rgba(255,255,255,0.8)" stroke-width="5" stroke-linecap="round"/>
                        </svg>
                        <span id="logo-text" class="text-blue-400 text-2xl ml-0.5 font-semibold">ceep</span>
                    </div>
                     <!-- NEW HEADER PILL CONTAINER -->
                    <div class="header-pill-container flex items-center gap-1 p-1 rounded-full">
                        <div class="relative group">
                            <button id="sidebar-toggle" type="button" class="w-10 h-10 flex items-center justify-center hover:bg-black/5 dark:hover:bg-white/10 focus:outline-none rounded-full btn-interaction">
                               <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5v14"></path>
                               </svg>
                            </button>
                            <span id="history-tooltip" class="absolute top-full left-1/2 -translate-x-1/2 mt-2 w-max px-2 py-1 bg-gray-900/80 backdrop-blur-sm text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">Lịch sử Chat</span>
                        </div>
                        <div class="relative group">
                            <button id="new-chat-header-btn" type="button" class="w-10 h-10 flex items-center justify-center hover:bg-black/5 dark:hover:bg-white/10 focus:outline-none rounded-full btn-interaction">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            </button>
                            <span id="new-chat-tooltip" class="absolute top-full left-1/2 -translate-x-1/2 mt-2 w-max px-2 py-1 bg-gray-900/80 backdrop-blur-sm text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">Chat Mới</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Token Display -->
                    <div id="token-display" class="flex items-center gap-1 text-sm font-semibold p-2 rounded-lg bg-gray-500/10">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                        <div id="token-inputs-container" class="flex items-center">
                            <input type="number" id="current-token-input" class="w-12 bg-transparent text-center focus:outline-none focus:ring-1 focus:ring-orange-500 rounded">
                            <span class="mx-1">/</span>
                            <input type="number" id="max-token-input" class="w-12 bg-transparent text-center focus:outline-none focus:ring-1 focus:ring-orange-500 rounded">
                        </div>
                        <span id="token-infinity" class="hidden">∞</span>
                    </div>

                    <!-- NEW UI PILL CONTAINER -->
                    <div class="header-pill-container flex items-center gap-1 p-1 rounded-full">
                        <div class="relative group">
                            <button id="lang-switch-btn" type="button" class="w-10 h-10 flex items-center justify-center hover:bg-black/5 dark:hover:bg-white/10 focus:outline-none rounded-full text-sm font-semibold btn-interaction">VI</button>
                             <span id="lang-tooltip" class="absolute top-full left-1/2 -translate-x-1/2 mt-2 w-max px-2 py-1 bg-gray-900/80 backdrop-blur-sm text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">Đổi Ngôn Ngữ</span>
                        </div>
                        <div class="relative group">
                            <button id="theme-menu-button" type="button" class="w-10 h-10 flex items-center justify-center hover:bg-black/5 dark:hover:bg-white/10 focus:outline-none rounded-full text-sm p-2.5 btn-interaction">
                                <svg id="theme-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path></svg>
                            </button>
                            <span id="theme-tooltip" class="absolute top-full left-1/2 -translate-x-1/2 mt-2 w-max px-2 py-1 bg-gray-900/80 backdrop-blur-sm text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">Đổi Giao Diện</span>
                        </div>
                    </div>
                </div>
            </header>
            <main id="mainContent" class="flex-grow flex flex-col p-4 transition-all duration-500 z-10 overflow-hidden">
                <!-- MODIFICATION: Centered chat container -->
                <div id="chat-container" class="w-full max-w-3xl mx-auto flex-grow mb-4 overflow-y-auto hidden hide-scrollbar px-4"></div>
                <div id="initial-view" class="flex-grow flex items-center justify-center text-center transition-opacity duration-500">
                     <div class="flex flex-col items-center">
                         <h1 id="main-title" class="text-5xl font-bold mb-4 opacity-0"></h1>
                    </div>
                </div>
            </main>

            <footer class="sticky bottom-0 left-0 right-0 bg-transparent pb-4 z-10">
                <div class="w-full max-w-3xl mx-auto px-4">
                    <form id="chat-form" class="relative flex flex-col bg-black/30 backdrop-blur-lg rounded-full shadow-lg p-1 border border-white/20">
                        <div id="file-thumbnail-container" class="px-2 pt-2"></div>
                        <div class="flex items-start w-full">
                            <input type="text" id="message-input" placeholder="Bạn muốn biết gì?" autocomplete="off" class="flex-grow bg-transparent border-none focus:ring-0 focus:outline-none text-lg pl-5 pt-3 pb-3 text-gray-200 placeholder-gray-500">

                            <div class="flex items-center shrink-0 pr-1 pt-1">
                                <!-- NEW ICON BUTTONS -->
                                <div class="relative group">
                                    <button type="button" id="random-prompt-icon-btn" class="p-2.5 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors btn-interaction hidden">
                                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                          <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" />
                                        </svg>
                                    </button>
                                    <span id="random-tooltip" class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max px-2 py-1 bg-gray-900/80 backdrop-blur-sm text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">Ngẫu nhiên</span>
                                </div>

                                <div class="relative group">
                                    <button type="button" id="video-icon-btn" class="p-2.5 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors btn-interaction">
                                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                          <path stroke-linecap="round" stroke-linejoin="round" d="m15.75 10.5 4.72-4.72a.75.75 0 0 1 1.28.53v11.38a.75.75 0 0 1-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 0 0 2.25-2.25v-9A2.25 2.25 0 0 0 13.5 5.25h-9A2.25 2.25 0 0 0 2.25 7.5v9A2.25 2.25 0 0 0 4.5 18.75Z" />
                                        </svg>
                                    </button>
                                    <span id="video-tooltip" class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max px-2 py-1 bg-gray-900/80 backdrop-blur-sm text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">Tạo Video</span>
                                </div>

                                <div class="relative group">
                                    <button type="button" id="learn-icon-btn" class="p-2.5 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors btn-interaction">
                                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                          <path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.627 48.627 0 0 1 12 20.904a48.627 48.627 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.57 50.57 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.902 59.902 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" />
                                        </svg>
                                    </button>
                                     <span id="learn-tooltip" class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max px-2 py-1 bg-gray-900/80 backdrop-blur-sm text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">Học Tập</span>
                                </div>

                                <button type="button" id="upload-file-btn" class="p-2.5 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors btn-interaction">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                                </button>
                                <input type="file" id="file-input" class="hidden" accept="image/jpeg, image/png, image/webp">

                                <div class="relative">
                                    <button type="button" id="model-button" class="flex items-center gap-1.5 px-4 py-2.5 rounded-lg text-sm text-gray-300 hover:bg-gray-700/50 transition btn-interaction">
                                        <span id="model-button-text-display">Mini</span>
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                           <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                                        </svg>
                                    </button>
                                    <div id="model-popup" class="hidden absolute bottom-full right-0 mb-2 w-72 rounded-2xl p-2 shadow-lg transition bg-gray-900 border border-gray-700 space-y-1">
                                       <!-- Nội dung sẽ được tạo bằng JS -->
                                    </div>
                                </div>
                                
                                <button type="button" id="sound-wave-button" class="flex items-center justify-center w-11 h-11 bg-gray-200 text-gray-400 rounded-full transition-colors shrink-0 ml-1 btn-interaction">
                                    <svg class="w-6 h-6 -rotate-45" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2">
                                        <path d="M7.39999 6.32003L15.89 3.49003C19.7 2.22003 21.77 4.30003 20.51 8.11003L17.68 16.6C15.78 22.31 12.66 22.31 10.76 16.6L9.91999 14.08L7.39999 13.24C1.68999 11.34 1.68999 8.23003 7.39999 6.32003Z" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M10.11 13.6501L13.69 10.0601" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>

                                <button type="submit" id="send-button" class="hidden flex items-center justify-center w-11 h-11 bg-blue-600 text-white rounded-full transition-colors shrink-0 ml-1 btn-interaction">
                                   <svg class="w-6 h-6 -rotate-45 text-white" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2">
                                        <path d="M7.39999 6.32003L15.89 3.49003C19.7 2.22003 21.77 4.30003 20.51 8.11003L17.68 16.6C15.78 22.31 12.66 22.31 10.76 16.6L9.91999 14.08L7.39999 13.24C1.68999 11.34 1.68999 8.23003 7.39999 6.32003Z" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M10.11 13.6501L13.69 10.0601" stroke-linecap="round" stroke-linejoin="round"/>
                                   </svg>
                                </button>

                                <button type="button" id="stop-button" class="hidden flex items-center justify-center w-11 h-11 bg-red-600 text-white rounded-full transition-colors shrink-0 ml-1 btn-interaction">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M5 5h10v10H5z" /></svg>
                                </button>
                            </div>
                        </div>
                    </form>
                    <p id="footer-text" class="text-center text-xs mt-2">AI có thể mắc lỗi. Hãy cân nhắc kiểm tra thông tin quan trọng.</p>
                </div>
            </footer>
        </div>
</div>

<!-- Popup chọn Giao diện -->
<div id="theme-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
    <div id="modal-content" class="bg-white/90 backdrop-blur-lg dark:bg-black/80 rounded-2xl shadow-2xl p-6 w-full max-w-2xl border border-gray-300 dark:border-white/20">
        <h2 id="theme-modal-title" class="text-xl font-bold mb-5 text-gray-800 dark:text-white text-center">Chọn Giao Diện</h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <button data-theme="dark" class="theme-option btn-interaction flex flex-col items-center justify-center gap-2 p-4 rounded-lg transition-colors duration-300 hover:bg-gray-500/10 dark:hover:bg-white/10">
                <div class="w-full h-16 rounded-md bg-[#212935] flex items-center justify-center">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </div>
                <span id="theme-dark-text" class="text-sm font-medium text-gray-700 dark:text-gray-300">Tối</span>
            </button>
             <button data-theme="light" class="theme-option btn-interaction flex flex-col items-center justify-center gap-2 p-4 rounded-lg transition-colors duration-300 hover:bg-gray-500/10 dark:hover:bg-white/10">
                <div class="w-full h-16 rounded-md bg-gray-100 border border-gray-300 flex items-center justify-center">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-..707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                </div>
                <span id="theme-light-text" class="text-sm font-medium text-gray-700 dark:text-gray-300">Sáng</span>
            </button>
            <button data-theme="ocean" class="theme-option btn-interaction flex flex-col items-center justify-center gap-2 p-4 rounded-lg transition-colors duration-300 hover:bg-gray-500/10 dark:hover:bg-white/10">
                <div class="w-full h-16 rounded-md bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=1173&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');">
                </div>
                <span id="theme-ocean-text" class="text-sm font-medium text-gray-700 dark:text-gray-300">Biển</span>
            </button>
        </div>
         <button id="close-modal-button" class="mt-6 w-full py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-500/10 dark:hover:bg-white/10 rounded-lg transition btn-interaction">Đóng</button>
    </div>
</div>

<!-- Language Modal -->
<div id="language-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
    <div id="language-modal-content" class="modal-fade-enter bg-white/90 backdrop-blur-lg dark:bg-black/80 rounded-2xl shadow-2xl p-6 w-full max-w-md border border-gray-300 dark:border-white/20">
        <h2 id="language-modal-title" class="text-xl font-bold mb-5 text-gray-800 dark:text-white text-center">Chọn Ngôn Ngữ</h2>
        <div class="grid grid-cols-2 gap-3">
            <button data-lang="vi" class="language-option btn-interaction text-left p-3 rounded-lg transition-colors duration-300 hover:bg-gray-500/10 dark:hover:bg-white/10 text-gray-700 dark:text-gray-300">Tiếng Việt</button>
            <button data-lang="en" class="language-option btn-interaction text-left p-3 rounded-lg transition-colors duration-300 hover:bg-gray-500/10 dark:hover:bg-white/10 text-gray-700 dark:text-gray-300">English</button>
            <button data-lang="zh" class="language-option btn-interaction text-left p-3 rounded-lg transition-colors duration-300 hover:bg-gray-500/10 dark:hover:bg-white/10 text-gray-700 dark:text-gray-300">中文 (Giản thể)</button>
            <button data-lang="hi" class="language-option btn-interaction text-left p-3 rounded-lg transition-colors duration-300 hover:bg-gray-500/10 dark:hover:bg-white/10 text-gray-700 dark:text-gray-300">हिन्दी</button>
            <button data-lang="es" class="language-option btn-interaction text-left p-3 rounded-lg transition-colors duration-300 hover:bg-gray-500/10 dark:hover:bg-white/10 text-gray-700 dark:text-gray-300">Español</button>
            <button data-lang="fr" class="language-option btn-interaction text-left p-3 rounded-lg transition-colors duration-300 hover:bg-gray-500/10 dark:hover:bg-white/10 text-gray-700 dark:text-gray-300">Français</button>
            <button data-lang="ja" class="language-option btn-interaction text-left p-3 rounded-lg transition-colors duration-300 hover:bg-gray-500/10 dark:hover:bg-white/10 text-gray-700 dark:text-gray-300">日本語</button>
            <button data-lang="it" class="language-option btn-interaction text-left p-3 rounded-lg transition-colors duration-300 hover:bg-gray-500/10 dark:hover:bg-white/10 text-gray-700 dark:text-gray-300">Italiano</button>
        </div>
         <button id="close-language-modal-button" class="mt-6 w-full py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-500/10 dark:hover:bg-white/10 rounded-lg transition btn-interaction">Đóng</button>
    </div>
</div>

<!-- Update Log Modal -->
<div id="update-log-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
    <div id="update-log-content" class="modal-fade-enter bg-white/90 backdrop-blur-lg dark:bg-gray-800/90 rounded-2xl shadow-2xl p-6 w-full max-w-md border border-gray-300 dark:border-gray-700 text-gray-800 dark:text-white">
        <h2 class="text-2xl font-bold mb-4 text-center">Có gì mới?</h2>
        <div class="space-y-3 text-sm max-h-60 overflow-y-auto pr-2">
            <p><strong></strong></p>
            <ul class="list-disc list-inside pl-2 space-y-1">
                <li><strong>Sửa lỗi:</strong> Trả lời nhầm lẫn, giật lag.</li>
                <li><strong>UI và UX:</strong> Cải thiện cho trải nghiệm tốt hơn</li>
                <li><strong>Ngôn ngữ:</strong> 2 ngôn ngữ: Tiếng Nhật và Tiếng Ý</li>
                <li><strong>???:</strong> Cập nhật mỗi tuần. Chờ đợi nhé...</li>
            </ul>
        </div>
        <div class="mt-6 flex items-center justify-between">
            <div class="flex items-center">
                <input id="dont-show-again" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <label for="dont-show-again" class="ml-2 block text-sm text-gray-600 dark:text-gray-300">Không hiện lại cho đến cập nhật tiếp</label>
            </div>
            <button id="close-update-log" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 transition-colors btn-interaction">Đóng</button>
        </div>
    </div>
</div>

<!-- "Coming Soon" Modal for File Upload -->
<div id="coming-soon-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
    <div id="coming-soon-content" class="modal-fade-enter bg-black/80 backdrop-blur-lg rounded-2xl shadow-2xl p-8 w-full max-w-sm border border-white/20 flex flex-col items-center gap-4">
        <svg class="w-24 h-24" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M50 10L10 90H90L50 10Z" fill="#FBBF24"/>
            <path d="M50 10L10 90H90L50 10Z" stroke="black" stroke-width="5" stroke-linejoin="round"/>
            <rect x="45" y="40" width="10" height="20" rx="5" fill="#475569"/>
            <rect x="45" y="65" width="10" height="10" rx="5" fill="#475569"/>
        </svg>

        <h2 id="coming-soon-title" class="text-2xl font-bold text-white">Sắp có...</h2>
        <p id="coming-soon-text" class="text-gray-300 text-center">Tính năng này đang được phát triển.</p>
        <button id="close-coming-soon-modal" class="mt-4 w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 transition btn-interaction">Đóng</button>
    </div>
</div>

<!-- FRAME LỖI TOÀN MÀN HÌNH -->
<div id="error-overlay" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[100] p-4">
    <div class="modal-fade-enter bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md border border-red-500/50 flex flex-col items-center gap-4 text-white text-center">
        <!-- Biển báo -->
        <svg class="w-20 h-20 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
        </svg>
        
        <h2 id="error-title" class="text-2xl font-bold">Có Lỗi Xảy Ra Với FoxAI</h2>
        <p id="error-subtitle" class="text-gray-300">Lỗi từ mô hình Smart, chúng tôi đang khắc phục!</p>
        
        <!-- Nút chuyển ngôn ngữ -->
        <button id="error-lang-switch-btn" class="mt-4 w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 transition btn-interaction">
            Switch to English
        </button>
    </div>
</div>


<script>
    // Setting bao tri hay khong
    let isErrorOverlayVisibleOnLoad = false; 

    //=====================================================================//
    // NEW: ENERGY CONFIGURATION BOX                                       //
    // Dễ dàng điều chỉnh các thông số Năng lượng tại đây.                    //
    //=====================================================================//
    const tokenConfig = {
        // Chế độ Vô hạn: true = năng lượng vô hạn, false = năng lượng có giới hạn.
        IS_INFINITE: true,

        // Năng lượng Tối đa (chỉ hoạt động khi IS_INFINITE = false).
        MAX_TOKENS: 50,

        // Chi phí mỗi tin nhắn (chỉ hoạt động khi IS_INFINITE = false).
        TOKEN_COST_PER_MESSAGE: 1,

        // Thời gian hồi Năng lượng (tính bằng phút, chỉ hoạt động khi IS_INFINITE = false).
        TOKEN_REGEN_INTERVAL_MINUTES: 5,

        // Lượng Năng lượng được hồi mỗi lần (chỉ hoạt động khi IS_INFINITE = false).
        TOKEN_REGEN_AMOUNT: 1,
    };
    //=====================================================================//

    const themeMenuButton = document.getElementById('theme-menu-button');
    const themeModal = document.getElementById('theme-modal');
    const modalContent = document.getElementById('modal-content');
    const closeModalButton = document.getElementById('close-modal-button');
    const themeOptionButtons = document.querySelectorAll('.theme-option');
    const languageModal = document.getElementById('language-modal');
    const closeLanguageModalBtn = document.getElementById('close-language-modal-button');
    const languageOptionButtons = document.querySelectorAll('.language-option');
    
    const body = document.body;
    const backgroundContainer = document.getElementById('background-container');
    const chatFormEl = document.getElementById('chat-form');
    const oceanImageUrl = 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=1173&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D';

    const appContainer = document.getElementById('app-container');
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const historyList = document.getElementById('history-list');
    const newChatHeaderBtn = document.getElementById('new-chat-header-btn');
    const langSwitchBtn = document.getElementById('lang-switch-btn');
    const sendButton = document.getElementById('send-button');
    const soundWaveButton = document.getElementById('sound-wave-button');
    const stopButton = document.getElementById('stop-button');
    const messageInput = document.getElementById('message-input');
    const randomPromptBtn = document.getElementById('random-prompt-icon-btn');
    const comingSoonModal = document.getElementById('coming-soon-modal');
    const closeComingSoonModal = document.getElementById('close-coming-soon-modal');


    // File upload elements
    const uploadFileBtn = document.getElementById('upload-file-btn');
    const fileInput = document.getElementById('file-input');
    const fileThumbnailContainer = document.getElementById('file-thumbnail-container');
    let stagedFile = null;

    // Token management elements
    const tokenInputsContainer = document.getElementById('token-inputs-container');
    const currentTokenInput = document.getElementById('current-token-input');
    const maxTokenInput = document.getElementById('max-token-input');
    const tokenInfinity = document.getElementById('token-infinity');


    let currentLang = 'vi';
    // --- STATE MANAGEMENT: Load persistent state from localStorage on script start ---
    let isTutorMode = localStorage.getItem('isTutorMode') === 'true';
    let currentModel = JSON.parse(localStorage.getItem('currentModel')) || { model: 'Mini', version: '' };
    // ---
    let abortController;
    let isRandomPromptUsedInSession = false;


    const translations = {
        vi: {
            sidebarHeader: "Lịch sử Chat",
            newChatTitle: "Chat mới",
            messagePlaceholder: "Bạn muốn biết gì?",
            aiTypingPlaceholder: "AI đang trả lời...",
            outOfTokensPlaceholder: "Bạn đã hết lượt. Lượt sẽ hồi sau ít phút.",
            sendButton: "Gửi",
            stopButton: "Dừng",
            modelButtonDefault: "Expert",
            modelButtonPrefix: "Mô Hình",
            randomButton: "Ngẫu nhiên",
            videoButton: "Tạo Video",
            learnButton: "Học Tập",
            footerText: "AI có thể mắc lỗi. Hãy cân nhắc kiểm tra thông tin quan trọng.",
            themeModalTitle: "Chọn Giao Diện",
            languageModalTitle: "Chọn Ngôn Ngữ",
            themeDark: "Tối",
            themeLight: "Sáng",
            themeOcean: "Biển",
            modalClose: "Đóng",
            newChatHistory: "Cuộc trò chuyện mới",
            greetingMorning: "Chào buổi sáng",
            greetingNoon: "Chào buổi trưa",
            greetingAfternoon: "Chào buổi chiều",
            greetingEvening: "Chào buổi tối",
            errorPrefix: "Đã có lỗi xảy ra",
            comingSoon: "Sắp có",
            comingSoonTitle: "Sắp có...",
            comingSoonText: "Tính năng này đang được phát triển.",
            langTooltip: "Đổi Ngôn Ngữ",
            themeTooltip: "Đổi Giao Diện",
            historyTooltip: "Lịch Sử Chat",
            newChatTooltip: "Chat Mới",
            modelMiniDesc: "Nhanh và hiệu quả cho các tác vụ hàng ngày.",
            modelSmartDesc: "Cân bằng giữa tốc độ và sự thông minh.",
            modelNerdDesc: "Suy luận cao nhờ mô hình tiên tiến, cho ra kết quả chuẩn xác."
        },
        en: {
            sidebarHeader: "Chat History",
            newChatTitle: "New Chat",
            messagePlaceholder: "What do you want to know?",
            aiTypingPlaceholder: "AI is replying...",
            outOfTokensPlaceholder: "You're out of tokens. They regenerate over time.",
            sendButton: "Send",
            stopButton: "Stop",
            modelButtonDefault: "Expert",
            modelButtonPrefix: "Model",
            randomButton: "Random",
            videoButton: "Create Video",
            learnButton: "Study",
            footerText: "AI can make mistakes. Consider checking important information.",
            themeModalTitle: "Choose Theme",
            languageModalTitle: "Select Language",
            themeDark: "Dark",
            themeLight: "Light",
            themeOcean: "Ocean",
            modalClose: "Close",
            newChatHistory: "New Conversation",
            greetingMorning: "Good morning",
            greetingNoon: "Good afternoon",
            greetingAfternoon: "Good afternoon",
            greetingEvening: "Good evening",
            errorPrefix: "An error occurred",
            comingSoon: "Coming Soon",
            comingSoonTitle: "Coming Soon...",
            comingSoonText: "This feature is under development.",
            langTooltip: "Switch Language",
            themeTooltip: "Change Theme",
            historyTooltip: "Chat History",
            newChatTooltip: "New Chat",
            modelMiniDesc: "Fast and efficient for everyday tasks.",
            modelSmartDesc: "A balance between speed and intelligence.",
            modelNerdDesc: "The most powerful model for complex answers."
        },
        zh: {
            sidebarHeader: "聊天历史", newChatTitle: "新聊天", messagePlaceholder: "你想知道什么？", aiTypingPlaceholder: "AI正在回复...", outOfTokensPlaceholder: "您的代币已用完。它们会随着时间的推移而再生。", sendButton: "发送", stopButton: "停止", modelButtonDefault: "专家", modelButtonPrefix: "模型", randomButton: "随机", videoButton: "创建视频", learnButton: "学习", footerText: "人工智能可能会犯错误。请考虑核查重要信息。", themeModalTitle: "选择主题", languageModalTitle: "选择语言", themeDark: "黑暗", themeLight: "光", themeOcean: "海洋", modalClose: "关闭", newChatHistory: "新对话", greetingMorning: "早上好", greetingNoon: "中午好", greetingAfternoon: "下午好", greetingEvening: "晚上好", errorPrefix: "发生错误", comingSoon: "即将推出", comingSoonTitle: "即将推出...", comingSoonText: "此功能正在开发中。", langTooltip: "切换语言", themeTooltip: "更改主题", historyTooltip: "聊天历史", newChatTooltip: "新聊天", modelMiniDesc: "快速高效地完成日常任务。", modelSmartDesc: "速度与智能的平衡。", modelNerdDesc: "用于复杂答案的最强大模型。"
        },
        hi: {
            sidebarHeader: "चैट इतिहास", newChatTitle: "नई चैट", messagePlaceholder: "आप क्या जानना चाहते हैं?", aiTypingPlaceholder: "एआई जवाब दे रहा है...", outOfTokensPlaceholder: "आपके टोकन खत्म हो गए हैं। वे समय के साथ फिर से बन जाते हैं।", sendButton: "भेजें", stopButton: "रुकें", modelButtonDefault: "विशेषज्ञ", modelButtonPrefix: "मॉडल", randomButton: "यादृच्छिक", videoButton: "वीडियो बनाएं", learnButton: "अध्ययन", footerText: "एआई गलतियाँ कर सकता है। महत्वपूर्ण जानकारी की जाँच करने पर विचार करें।", themeModalTitle: "थीम चुनें", languageModalTitle: "भाषा चुनें", themeDark: "अंधेरा", themeLight: "प्रकाश", themeOcean: "सागर", modalClose: "बंद करें", newChatHistory: "नई बातचीत", greetingMorning: "सुप्रभात", greetingNoon: "नमस्ते", greetingAfternoon: "नमस्ते", greetingEvening: "शुभ संध्या", errorPrefix: "एक त्रुटि हुई", comingSoon: "जल्द आ रहा है", comingSoonTitle: "जल्द आ रहा है...", comingSoonText: "यह सुविधा विकास अधीन है।", langTooltip: "भाषा बदलें", themeTooltip: "थीम बदलें", historyTooltip: "चैट इतिहास", newChatTooltip: "नई चैट", modelMiniDesc: "रोजमर्रा के कार्यों के लिए तेज़ और कुशल।", modelSmartDesc: "गति और बुद्धिमत्ता के बीच संतुलन।", modelNerdDesc: "जटिल उत्तरों के लिए सबसे शक्तिशाली मॉडल।"
        },
        es: {
            sidebarHeader: "Historial de chat", newChatTitle: "Nuevo chat", messagePlaceholder: "¿Qué quieres saber?", aiTypingPlaceholder: "La IA está respondiendo...", outOfTokensPlaceholder: "Te has quedado sin tokens. Se regeneran con el tiempo.", sendButton: "Enviar", stopButton: "Detener", modelButtonDefault: "Experto", modelButtonPrefix: "Modelo", randomButton: "Aleatorio", videoButton: "Crear video", learnButton: "Estudiar", footerText: "La IA puede cometer errores. Considere verificar información importante.", themeModalTitle: "Elegir tema", languageModalTitle: "Seleccionar idioma", themeDark: "Oscuro", themeLight: "Luz", themeOcean: "Océano", modalClose: "Cerrar", newChatHistory: "Nueva conversación", greetingMorning: "Buenos días", greetingNoon: "Buenas tardes", greetingAfternoon: "Buenas tardes", greetingEvening: "Buenas noches", errorPrefix: "Ocurrió un error", comingSoon: "Próximamente", comingSoonTitle: "Próximamente...", comingSoonText: "Esta función está en desarrollo.", langTooltip: "Cambiar idioma", themeTooltip: "Cambiar tema", historyTooltip: "Historial de chat", newChatTooltip: "Nuevo chat", modelMiniDesc: "Rápido y eficiente para las tareas diarias.", modelSmartDesc: "Un equilibrio entre velocidad e inteligencia.", modelNerdDesc: "El modelo más potente para respuestas complejas."
        },
        fr: {
            sidebarHeader: "Historique des discussions", newChatTitle: "Nouvelle discussion", messagePlaceholder: "Que voulez-vous savoir ?", aiTypingPlaceholder: "L'IA répond...", outOfTokensPlaceholder: "Vous n'avez plus de jetons. Ils se régénèrent avec le temps.", sendButton: "Envoyer", stopButton: "Arrêter", modelButtonDefault: "Expert", modelButtonPrefix: "Modèle", randomButton: "Aléatoire", videoButton: "Créer une vidéo", learnButton: "Étudier", footerText: "L'IA peut faire des erreurs. Pensez à vérifier les informations importantes.", themeModalTitle: "Choisir un thème", languageModalTitle: "Sélectionner la langue", themeDark: "Sombre", themeLight: "Lumière", themeOcean: "Océan", modalClose: "Fermer", newChatHistory: "Nouvelle conversation", greetingMorning: "Bonjour", greetingNoon: "Bon après-midi", greetingAfternoon: "Bon après-midi", greetingEvening: "Bonsoir", errorPrefix: "Une erreur est survenue", comingSoon: "Bientôt disponible", comingSoonTitle: "Bientôt disponible...", comingSoonText: "Cette fonctionnalité est en cours de développement.", langTooltip: "Changer de langue", themeTooltip: "Changer de thème", historyTooltip: "Historique des discussions", newChatTooltip: "Nouvelle discussion", modelMiniDesc: "Rapide et efficace pour les tâches quotidiennes.", modelSmartDesc: "Un équilibre entre vitesse et intelligence.", modelNerdDesc: "Le modèle le plus puissant pour les réponses complexes."
        },
        ja: {
            sidebarHeader: "チャット履歴",
            newChatTitle: "新しいチャット",
            messagePlaceholder: "何を知りたいですか？",
            aiTypingPlaceholder: "AIが返信中です...",
            outOfTokensPlaceholder: "トークンがなくなりました。時間とともに回復します。",
            sendButton: "送信",
            stopButton: "停止",
            modelButtonDefault: "エキスパート",
            modelButtonPrefix: "モデル",
            randomButton: "ランダム",
            videoButton: "ビデオを作成",
            learnButton: "勉強",
            footerText: "AIは間違いを犯す可能性があります。重要な情報を確認することを検討してください。",
            themeModalTitle: "テーマを選択",
            languageModalTitle: "言語を選択",
            themeDark: "ダーク",
            themeLight: "ライト",
            themeOcean: "海",
            modalClose: "閉じる",
            newChatHistory: "新しい会話",
            greetingMorning: "おはようございます",
            greetingNoon: "こんにちは",
            greetingAfternoon: "こんにちは",
            greetingEvening: "こんばんは",
            errorPrefix: "エラーが発生しました",
            comingSoon: "近日公開",
            comingSoonTitle: "近日公開...",
            comingSoonText: "この機能は開発中です。",
            langTooltip: "言語を切り替え",
            themeTooltip: "テーマを変更",
            historyTooltip: "チャット履歴",
            newChatTooltip: "新しいチャット",
            modelMiniDesc: "日常のタスクに迅速かつ効率的。",
            modelSmartDesc: "速度と知能のバランス。",
            modelNerdDesc: "複雑な回答のための最も強力なモデル。"
        },
        it: {
            sidebarHeader: "Cronologia Chat",
            newChatTitle: "Nuova Chat",
            messagePlaceholder: "Cosa vuoi sapere?",
            aiTypingPlaceholder: "L'IA sta rispondendo...",
            outOfTokensPlaceholder: "Hai esaurito i token. Si rigenerano nel tempo.",
            sendButton: "Invia",
            stopButton: "Ferma",
            modelButtonDefault: "Esperto",
            modelButtonPrefix: "Modello",
            randomButton: "Casuale",
            videoButton: "Crea Video",
            learnButton: "Studia",
            footerText: "L'IA può commettere errori. Considera di verificare le informazioni importanti.",
            themeModalTitle: "Scegli Tema",
            languageModalTitle: "Seleziona Lingua",
            themeDark: "Scuro",
            themeLight: "Chiaro",
            themeOcean: "Oceano",
            modalClose: "Chiudi",
            newChatHistory: "Nuova Conversazione",
            greetingMorning: "Buongiorno",
            greetingNoon: "Buon pomeriggio",
            greetingAfternoon: "Buon pomeriggio",
            greetingEvening: "Buonasera",
            errorPrefix: "Si è verificato un errore",
            comingSoon: "Prossimamente",
            comingSoonTitle: "Prossimamente...",
            comingSoonText: "Questa funzionalità è in fase di sviluppo.",
            langTooltip: "Cambia Lingua",
            themeTooltip: "Cambia Tema",
            historyTooltip: "Cronologia Chat",
            newChatTooltip: "Nuova Chat",
            modelMiniDesc: "Veloce ed efficiente per le attività quotidiane.",
            modelSmartDesc: "Un equilibrio tra velocità e intelligenza.",
            modelNerdDesc: "Il modello più potente per risposte complesse."
        }
    };


    const apiConfig = {
        'Mini': {
            key: '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',
            model: 'openai/gpt-oss-20b:free'
        },
        'Smart': {
            key: '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',
            model: 'minimax/minimax-m2:free'
        },
        'Nerd': {
            key: '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',
            model: 'kwaipilot/kat-coder-pro:free'
        }
    };
    let conversationHistory = [];
    let chatHistories = {};
    let currentChatId = null;

    const textElements = {
        header: document.getElementById('header-title'),
        main: document.getElementById('main-title'),
        input: document.getElementById('message-input'),
        footer: document.getElementById('footer-text'),
        themeIcon: document.getElementById('theme-icon'),
        logoText: document.getElementById('logo-text'),
        sidebarHeader: document.getElementById('sidebar-header'),
        modelBtnText: document.getElementById('model-button-text-display'),
        themeModalTitle: document.getElementById('theme-modal-title'),
        languageModalTitle: document.getElementById('language-modal-title'),
        themeDarkText: document.getElementById('theme-dark-text'),
        themeLightText: document.getElementById('theme-light-text'),
        themeOceanText: document.getElementById('theme-ocean-text'),
        closeModalButton: document.getElementById('close-modal-button'),
        closeLanguageModalBtn: document.getElementById('close-language-modal-button'),
        comingSoonTitle: document.getElementById('coming-soon-title'),
        comingSoonText: document.getElementById('coming-soon-text'),
        closeComingSoonModal: document.getElementById('close-coming-soon-modal'),
        randomTooltip: document.getElementById('random-tooltip'),
        videoTooltip: document.getElementById('video-tooltip'),
        learnTooltip: document.getElementById('learn-tooltip'),
        langTooltip: document.getElementById('lang-tooltip'),
        themeTooltip: document.getElementById('theme-tooltip'),
        historyTooltip: document.getElementById('history-tooltip'),
        newChatTooltip: document.getElementById('new-chat-tooltip'),
    };

    const themeColors = {
        dark: {
            bg: ['bg-gradient-to-br', 'from-[#212935]', 'to-black'],
            text: 'text-gray-100',
            subtleText: 'text-gray-400',
            logo: 'text-gray-100',
            iconColor: 'text-gray-300',
            popup: ['bg-gray-900', 'border', 'border-gray-700'],
            popupButton: ['text-gray-300', 'hover:bg-white/10', 'hover:text-white'],
            popupSelected: ['bg-sky-500/20', '!text-sky-300', 'font-semibold'],
            sidebar: ['bg-black/10', 'border-white/10'],
            sidebarText: 'text-gray-200',
            historyActive: ['bg-blue-800/50'],
            historyHover: ['hover:bg-blue-800/30'],
            form: ['bg-black/30', 'border-white/20'],
            headerPill: [],
            aiMessage: ['text-gray-100'],
            userMessage: ['bg-blue-600', 'text-white'],
            inputColor: ['text-gray-200', 'placeholder-gray-500']
        },
        light: {
            bg: ['bg-white'],
            text: 'text-black',
            subtleText: 'text-gray-600',
            logo: 'text-blue-500',
            iconColor: 'text-gray-800',
            popup: ['bg-white', 'border', 'border-gray-200', 'shadow-lg'],
            popupButton: ['text-gray-700', 'hover:bg-gray-100'],
            popupSelected: ['bg-blue-100', '!text-blue-600', 'font-semibold'],
            sidebar: ['bg-gray-50', 'border-r', 'border-gray-200'],
            sidebarText: 'text-black',
            historyActive: ['bg-blue-100'],
            historyHover: ['hover:bg-gray-200'],
            form: ['bg-gray-100', 'border', 'border-gray-300', 'shadow'],
            headerPill: [],
            aiMessage: ['text-black'],
            userMessage: ['bg-blue-500', 'text-white'],
            inputColor: ['text-black', 'placeholder-gray-400']
        },
        ocean: {
            bgImage: `url('${oceanImageUrl}')`,
            text: 'text-white',
            subtleText: 'text-gray-300',
            logo: 'text-white',
            iconColor: 'text-white',
            popup: ['bg-black/70', 'backdrop-blur-md', 'border', 'border-white/10'],
            popupButton: ['text-gray-300', 'hover:bg-white/10', 'hover:text-white'],
            popupSelected: ['bg-sky-400/20', '!text-sky-300', 'font-semibold'],
            sidebar: ['bg-black/10', 'border-white/10'],
            sidebarText: 'text-white',
            historyActive: ['bg-white/20'],
            historyHover: ['hover:bg-white/10'],
            form: ['bg-black/30', 'border-white/20'],
            headerPill: ['bg-black/30', 'backdrop-blur-lg', 'border', 'border-white/20'],
            aiMessage: ['text-white'],
            userMessage: ['bg-blue-500', 'text-white'],
            inputColor: ['text-white', 'placeholder-gray-300']
        }
    };
    
    function saveStateToLocalStorage() {
        const historiesToSave = { ...chatHistories };
        if (historiesToSave[currentChatId] && historiesToSave[currentChatId].length === 0) {
            delete historiesToSave[currentChatId];
        }
        localStorage.setItem('chatHistories', JSON.stringify(historiesToSave));
        localStorage.setItem('currentChatId', currentChatId);
    }
    
    function initializeApp() {
        const savedHistories = localStorage.getItem('chatHistories');
        if (savedHistories) {
            chatHistories = JSON.parse(savedHistories);
        } else {
            chatHistories = {};
        }
        startNewChat(); 
    }

    function applyTheme(theme) {
        body.className = "flex flex-col h-screen overflow-hidden transition-colors duration-500";
        backgroundContainer.className = "fixed inset-0 -z-10 transition-all duration-500 bg-cover bg-center";
        backgroundContainer.style.backgroundImage = '';
        const config = themeColors[theme];
        const allConfigs = Object.values(themeColors);

        themeOptionButtons.forEach(btn => {
            btn.classList.remove('bg-blue-500/20');
            if (btn.dataset.theme === theme) {
                 btn.classList.add('bg-blue-500/20');
            }
        });

        body.classList.remove(...allConfigs.flatMap(c => c.bg).flat());
        if (config.bgImage) {
            backgroundContainer.style.backgroundImage = config.bgImage;
            backgroundContainer.classList.add('image-overlay');
        } else {
            body.classList.add(...config.bg);
            backgroundContainer.classList.remove('image-overlay');
        }
        
        body.classList.remove(...allConfigs.map(c => c.text));
        body.classList.add(config.text);

        const allLogoColors = allConfigs.map(c => c.logo);
        textElements.logoText.classList.remove(...allLogoColors);
        textElements.logoText.classList.add(config.logo);

        const sidebarEl = document.getElementById('sidebar');
        const formEl = document.getElementById('chat-form');
        const pillEls = document.querySelectorAll('.header-pill-container');
        const allPillClasses = allConfigs.flatMap(c => c.headerPill || []).flat();
        sidebarEl.classList.remove(...allConfigs.flatMap(c => c.sidebar || []).flat());
        sidebarEl.classList.add(...(config.sidebar || []));
        formEl.classList.remove(...allConfigs.flatMap(c => c.form || []).flat());
        formEl.classList.add(...(config.form || []));
        pillEls.forEach(pill => {
            pill.classList.remove(...allPillClasses);
            pill.classList.add(...(config.headerPill || []));
        });

        const themeableIconEls = [
            sidebarToggle.querySelector('svg'), newChatHeaderBtn.querySelector('svg'),
            langSwitchBtn, document.getElementById('theme-icon'),
            document.querySelector('#random-prompt-icon-btn svg'), 
            document.querySelector('#video-icon-btn svg'), 
            document.querySelector('#learn-icon-btn svg'), 
            document.querySelector('#upload-file-btn svg')
        ];
        const allIconColors = allConfigs.map(c => c.iconColor);
        themeableIconEls.forEach(el => {
            if (el) {
                el.classList.remove(...allIconColors);
                el.classList.add(config.iconColor);
            }
        });
        
        const messageInputEl = document.getElementById('message-input');
        const allInputColors = allConfigs.flatMap(c => c.inputColor || []).flat();
        messageInputEl.classList.remove(...allInputColors);
        messageInputEl.classList.add(...(config.inputColor || []));

        textElements.footer.classList.remove(...allConfigs.map(c => c.subtleText));
        textElements.footer.classList.add(config.subtleText);
        const tokenDisplayIcon = document.querySelector('#token-display svg');
        tokenDisplayIcon.classList.remove(...allConfigs.map(c => c.iconColor));
        tokenDisplayIcon.classList.add(config.iconColor);

        const modelPopup = document.getElementById('model-popup');
        modelPopup.classList.remove(...allConfigs.flatMap(c => c.popup).flat());
        modelPopup.classList.add(...config.popup);

        const chatContainer = document.getElementById('chat-container');
        if (chatContainer) {
            const aiMessages = chatContainer.querySelectorAll('.ai-message-wrapper');
            const allAiMessageClasses = allConfigs.flatMap(c => c.aiMessage || []).flat();
            aiMessages.forEach(msg => {
                msg.classList.remove(...allAiMessageClasses);
                msg.classList.add(...config.aiMessage);
            });
            const userMessages = chatContainer.querySelectorAll('.user-message-wrapper');
            const allUserMessageClasses = allConfigs.flatMap(c => c.userMessage || []).flat();
            userMessages.forEach(msg => {
                msg.classList.remove(...allUserMessageClasses);
                msg.classList.add(...config.userMessage);
            });
        }

        localStorage.setItem('theme', theme);
        renderHistoryList();
        updateLearnButtonVisualState();
    }
    
    function updateActiveLanguageButton(lang) {
        languageOptionButtons.forEach(btn => {
            btn.classList.remove('bg-blue-500/20', 'text-blue-600');
            if (btn.dataset.lang === lang) {
                btn.classList.add('bg-blue-500/20', 'text-blue-600');
            }
        });
    }

    function switchLanguage(lang) {
        currentLang = lang;
        const t = translations[lang];

        textElements.sidebarHeader.textContent = t.sidebarHeader;
        textElements.input.placeholder = t.messagePlaceholder;
        textElements.footer.textContent = t.footerText;
        textElements.themeModalTitle.textContent = t.themeModalTitle;
        textElements.languageModalTitle.textContent = t.languageModalTitle;
        textElements.themeDarkText.textContent = t.themeDark;
        textElements.themeLightText.textContent = t.themeLight;
        textElements.themeOceanText.textContent = t.themeOcean;
        textElements.closeModalButton.textContent = t.modalClose;
        textElements.closeLanguageModalBtn.textContent = t.modalClose;
        textElements.comingSoonTitle.textContent = t.comingSoonTitle;
        textElements.comingSoonText.textContent = t.comingSoonText;
        textElements.closeComingSoonModal.textContent = t.modalClose;
        textElements.randomTooltip.textContent = t.randomButton;
        textElements.videoTooltip.textContent = t.videoButton;
        textElements.learnTooltip.textContent = t.learnButton;
        textElements.langTooltip.textContent = t.langTooltip;
        textElements.themeTooltip.textContent = t.themeTooltip;
        textElements.historyTooltip.textContent = t.historyTooltip;
        textElements.newChatTooltip.textContent = t.newChatTooltip;

        langSwitchBtn.textContent = lang.toUpperCase();

        document.documentElement.lang = lang;
        localStorage.setItem('language', lang);
        
        updateActiveLanguageButton(lang);
        updateModelButtonText();
        setGreeting();
        renderHistoryList();
        updateTokenUI();
    }

    let isModalAnimating = false;
    const animationDuration = 300;

    function showModal(modal, show) {
        if (isModalAnimating && (modal === themeModal || modal === languageModal || modal === document.getElementById('update-log-modal') || modal === comingSoonModal)) return;
        isModalAnimating = true;
        const content = modal.querySelector('div[id$="-content"]');
        if (show) {
            modal.classList.remove('hidden');
            content.classList.remove('modal-fade-leave');
            content.classList.add('modal-fade-enter');
        } else {
            content.classList.remove('modal-fade-enter');
            content.classList.add('modal-fade-leave');
        }
        setTimeout(() => {
            if (!show) {
                modal.classList.add('hidden');
            }
            isModalAnimating = false;
        }, animationDuration);
    }

    function toggleThemeModal() {
        const isHidden = themeModal.classList.contains('hidden');
        showModal(themeModal, isHidden);
    }

    function setGreeting() {
        const mainTitle = document.getElementById('main-title');
        if (!mainTitle) return;
        const now = new Date();
        const hour = now.getHours();
        const t = translations[currentLang];
        let greeting = '';
        if (hour >= 5 && hour < 11) greeting = t.greetingMorning;
        else if (hour >= 11 && hour < 14) greeting = t.greetingNoon;
        else if (hour >= 14 && hour < 18) greeting = t.greetingAfternoon;
        else greeting = t.greetingEvening;
        mainTitle.textContent = greeting;
    }

    themeMenuButton.addEventListener('click', toggleThemeModal);
    closeModalButton.addEventListener('click', () => showModal(themeModal, false));
    themeModal.addEventListener('click', (e) => {
        if (e.target === themeModal) showModal(themeModal, false);
    });

    themeOptionButtons.forEach(button => {
        button.addEventListener('click', () => {
            const theme = button.getAttribute('data-theme');
            applyTheme(theme);
            showModal(themeModal, false);
        });
    });

    sidebarToggle.addEventListener('click', () => {
        sidebar.classList.toggle('-translate-x-full');
        sidebar.classList.toggle('hidden');
    });

    function startNewChat() {
        currentChatId = Date.now().toString();
        conversationHistory = [];
        chatHistories[currentChatId] = conversationHistory;
        chatContainer.innerHTML = '';
        initialView.classList.remove('hidden');
        chatContainer.classList.add('hidden');
        mainContent.classList.add('justify-center');
        mainContent.classList.remove('justify-start');
        setGreeting();
        
        isRandomPromptUsedInSession = false; 
        updateRandomButtonVisibility();
        
        renderHistoryList();
        setActiveHistoryItem(currentChatId);
        saveStateToLocalStorage();
    }
    
    function updateRandomButtonVisibility() {
        if (conversationHistory.length === 0 && !isRandomPromptUsedInSession) {
            randomPromptBtn.classList.remove('hidden');
        } else {
            randomPromptBtn.classList.add('hidden');
        }
    }


    function renderHistoryList() {
        historyList.innerHTML = '';
        const currentTheme = localStorage.getItem('theme') || 'dark';
        const themeConfig = themeColors[currentTheme];

        Object.keys(chatHistories).sort().reverse().forEach(chatId => {
            const history = chatHistories[chatId];
            if (chatId === currentChatId && history.length === 0) return;

            let firstMessageText = translations[currentLang].newChatHistory;
            if (history.length > 0) {
                const firstContent = history[0].content;
                if (typeof firstContent === 'string') {
                    firstMessageText = firstContent;
                } else if (Array.isArray(firstContent)) {
                    const mediaPart = firstContent.find(p => p.type === 'image_url' || p.type === 'video_url');
                    const textPart = firstContent.find(p => p.type === 'text');

                    if (mediaPart && mediaPart.type === 'image_url') firstMessageText = '[Hình ảnh]';
                    if (mediaPart && mediaPart.type === 'video_url') firstMessageText = '[Video]';

                    if (textPart && textPart.text) {
                       firstMessageText = (mediaPart ? firstMessageText + " " : "") + textPart.text;
                    }
                }
            }

            const item = document.createElement('div');
            item.className = 'history-item flex items-center justify-between p-2 rounded-md cursor-pointer';
            item.classList.add(...themeConfig.historyHover);
            item.dataset.chatId = chatId;

            const text = document.createElement('span');
            text.className = 'text-sm truncate';
            text.textContent = firstMessageText.substring(0, 25) + (firstMessageText.length > 25 ? '...' : '');

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'p-1 rounded-md hover:bg-red-500/20 text-gray-500 hover:text-red-500';
            deleteBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                delete chatHistories[chatId];
                if (currentChatId === chatId) startNewChat();
                else {
                   saveStateToLocalStorage();
                   renderHistoryList();
                }
            };

            item.appendChild(text);
            item.appendChild(deleteBtn);
            item.onclick = () => loadChatHistory(chatId);
            historyList.appendChild(item); 
        });
        if(currentChatId) setActiveHistoryItem(currentChatId);
    }

    function loadChatHistory(chatId) {
        currentChatId = chatId;
        conversationHistory = chatHistories[chatId] || [];
        chatContainer.innerHTML = '';

        if(conversationHistory.length > 0) {
             initialView.classList.add('hidden');
             chatContainer.classList.remove('hidden');
             mainContent.classList.remove('justify-center');
             mainContent.classList.add('justify-start');
             conversationHistory.forEach(msg => {
                const el = createMessageElement(msg.content, msg.role);
                chatContainer.appendChild(el);
             });
             if (window.MathJax) MathJax.typesetPromise([chatContainer]);
        } else {
             initialView.classList.remove('hidden');
             chatContainer.classList.add('hidden');
             setGreeting();
        }
         setActiveHistoryItem(chatId);
         updateRandomButtonVisibility();
         saveStateToLocalStorage();
    }

    function setActiveHistoryItem(chatId) {
        const currentTheme = localStorage.getItem('theme') || 'dark';
        const themeConfig = themeColors[currentTheme];
        document.querySelectorAll('.history-item').forEach(item => {
            item.classList.remove(...Object.values(themeColors).flatMap(t => t.historyActive).flat());
            if(item.dataset.chatId === chatId) item.classList.add(...themeConfig.historyActive);
        });
    }

    newChatHeaderBtn.addEventListener('click', startNewChat);

    document.addEventListener('DOMContentLoaded', () => {
        // --- LOGIC CHO KHUNG LỖI ---
        const errorOverlay = document.getElementById('error-overlay');
        const errorLangSwitchBtn = document.getElementById('error-lang-switch-btn');
        const errorTitle = document.getElementById('error-title');
        const errorSubtitle = document.getElementById('error-subtitle');
        let isErrorInEnglish = false; // Ban đầu là tiếng Việt

        function updateErrorLanguage() {
            if (isErrorInEnglish) {
                errorTitle.textContent = "An Error Occurred with FoxAI";
                errorSubtitle.textContent = "Error from Smart model, we are fixing it!";
                errorLangSwitchBtn.textContent = "Chuyển sang Tiếng Việt";
            } else {
                errorTitle.textContent = "Có Lỗi Xảy Ra Với FoxAI";
                errorSubtitle.textContent = "Lỗi từ mô hình Smart, chúng tôi đang khắc phục!";
                errorLangSwitchBtn.textContent = "Switch to English";
            }
        }
        
        errorLangSwitchBtn.addEventListener('click', () => {
            isErrorInEnglish = !isErrorInEnglish;
            updateErrorLanguage();
        });

        // Kiểm tra giá trị của biến `isErrorOverlayVisibleOnLoad` để hiển thị hoặc ẩn khung lỗi
        if (isErrorOverlayVisibleOnLoad) {
            errorOverlay.classList.remove('hidden');
        } else {
            errorOverlay.classList.add('hidden');
        }
        // --- KẾT THÚC LOGIC KHUNG LỖI ---
        
        
        const savedTheme = localStorage.getItem('theme') || 'dark';
        const savedLang = localStorage.getItem('language') || 'vi';
        
        switchLanguage(savedLang);
        applyTheme(savedTheme);
        initializeApp();
        handleUpdateLog();
        initTokenSystem();
        
        soundWaveButton.classList.remove('hidden');
        sendButton.classList.add('hidden');

        updateModelButtonText();
        updateLearnButtonVisualState();

        messageInput.addEventListener('input', () => {
            if (messageInput.value.trim().length > 0) {
                soundWaveButton.classList.add('hidden');
                sendButton.classList.remove('hidden');
                isRandomPromptUsedInSession = true; 
                updateRandomButtonVisibility(); 
            } else {
                soundWaveButton.classList.remove('hidden');
                sendButton.classList.add('hidden');
            }
        });

        const initialView = document.getElementById('initial-view');
        if (!initialView.classList.contains('hidden')) {
             document.getElementById('main-title').classList.add('animate-fade-up');
        }

        // --- NEW: Event Listeners for shortcuts and auto-focus ---
        document.addEventListener('keydown', (e) => {
            // Shortcut Ctrl + G for new chat
            if (e.ctrlKey && e.key.toLowerCase() === 'g') {
                e.preventDefault();
                startNewChat();
            }

            // Auto-focus input field when user starts typing anywhere
            const activeEl = document.activeElement;
            const isTypingInInput = activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA';
            // Check if the key is a single printable character and not part of a shortcut
            if (!isTypingInInput && e.key.length === 1 && !e.ctrlKey && !e.altKey && !e.metaKey) {
                messageInput.focus();
            }
        });
    });

    function handleUpdateLog() {
        const updateLogModal = document.getElementById('update-log-modal');
        const closeUpdateLogBtn = document.getElementById('close-update-log');
        const dontShowAgainCheckbox = document.getElementById('dont-show-again');
        const updateLogVersion = '1.0.2'; // Updated version for new languages
        const hasSeenUpdate = localStorage.getItem('seenUpdateLogVersion');

        if (hasSeenUpdate !== updateLogVersion) showModal(updateLogModal, true);

        const closeAndSavePreference = () => {
            if (dontShowAgainCheckbox.checked) localStorage.setItem('seenUpdateLogVersion', updateLogVersion);
            showModal(updateLogModal, false);
        };

        closeUpdateLogBtn.addEventListener('click', closeAndSavePreference);
        updateLogModal.addEventListener('click', (e) => {
            if(e.target === updateLogModal) closeAndSavePreference();
        });
    }

    function initTokenSystem() {
        if (tokenConfig.IS_INFINITE) {
            updateTokenUI();
            return;
        }

        let maxTokens = localStorage.getItem('maxTokens');
        if (maxTokens === null) {
            maxTokens = tokenConfig.MAX_TOKENS;
            localStorage.setItem('maxTokens', maxTokens);
        }

        let userTokens = localStorage.getItem('userTokens');
        if (userTokens === null) {
            userTokens = maxTokens;
            localStorage.setItem('userTokens', userTokens);
            localStorage.setItem('lastTokenRegenTimestamp', Date.now());
        }

        currentTokenInput.addEventListener('change', handleTokenInputChange);
        maxTokenInput.addEventListener('change', handleTokenInputChange);
        regenerateTokens();
        setInterval(regenerateTokens, 60 * 1000);
    }

    function handleTokenInputChange() {
        let newCurrent = parseInt(currentTokenInput.value);
        let newMax = parseInt(maxTokenInput.value);
        if (isNaN(newMax) || newMax < 1) newMax = parseInt(localStorage.getItem('maxTokens')) || tokenConfig.MAX_TOKENS;
        if (isNaN(newCurrent) || newCurrent < 0) newCurrent = 0;
        if (newCurrent > newMax) newCurrent = newMax;
        localStorage.setItem('userTokens', newCurrent);
        localStorage.setItem('maxTokens', newMax);
        updateTokenUI();
    }

    function regenerateTokens() {
        if (tokenConfig.IS_INFINITE) return;
        const maxTokens = parseInt(localStorage.getItem('maxTokens'));
        let currentTokens = parseInt(localStorage.getItem('userTokens') || '0');
        if (currentTokens >= maxTokens) {
            updateTokenUI();
            return;
        }
        const lastRegenTimestamp = parseInt(localStorage.getItem('lastTokenRegenTimestamp') || Date.now());
        const now = Date.now();
        const timeElapsed = now - lastRegenTimestamp;
        const regenIntervalMs = tokenConfig.TOKEN_REGEN_INTERVAL_MINUTES * 60 * 1000;
        if (timeElapsed >= regenIntervalMs) {
            const intervalsPassed = Math.floor(timeElapsed / regenIntervalMs);
            const tokensToAdd = intervalsPassed * tokenConfig.TOKEN_REGEN_AMOUNT;
            currentTokens = Math.min(maxTokens, currentTokens + tokensToAdd);
            localStorage.setItem('userTokens', currentTokens);
            localStorage.setItem('lastTokenRegenTimestamp', now);
        }
        updateTokenUI();
    }

    function updateTokenUI() {
        messageInput.disabled = false;
        if (tokenConfig.IS_INFINITE) {
            tokenInputsContainer.classList.add('hidden');
            tokenInfinity.classList.remove('hidden');
            messageInput.placeholder = translations[currentLang].messagePlaceholder;
            return;
        }
        tokenInputsContainer.classList.remove('hidden');
        tokenInfinity.classList.add('hidden');
        const currentTokens = parseInt(localStorage.getItem('userTokens') || '0');
        const maxTokens = parseInt(localStorage.getItem('maxTokens') || tokenConfig.MAX_TOKENS);
        currentTokenInput.value = currentTokens;
        maxTokenInput.value = maxTokens;
        if (currentTokens < tokenConfig.TOKEN_COST_PER_MESSAGE) {
            messageInput.disabled = true;
            messageInput.placeholder = translations[currentLang].outOfTokensPlaceholder;
        } else {
            messageInput.placeholder = translations[currentLang].messagePlaceholder;
        }
    }

    function consumeToken() {
        if (tokenConfig.IS_INFINITE) return true;
        let currentTokens = parseInt(localStorage.getItem('userTokens') || '0');
        if (currentTokens >= tokenConfig.TOKEN_COST_PER_MESSAGE) {
            currentTokens -= tokenConfig.TOKEN_COST_PER_MESSAGE;
            localStorage.setItem('userTokens', currentTokens);
            updateTokenUI();
            return true;
        }
        return false;
    }

    const chatForm = document.getElementById('chat-form');
    const chatContainer = document.getElementById('chat-container');
    const initialView = document.getElementById('initial-view');
    const mainContent = document.getElementById('mainContent');
    const videoBtn = document.getElementById('video-icon-btn');
    const learnBtn = document.getElementById('learn-icon-btn');
    const modelButton = document.getElementById('model-button');
    const modelPopup = document.getElementById('model-popup');

    const randomPrompts = {
        vi: ["Kể một câu chuyện cười", "Thủ đô của nước Pháp là gì?", "Viết một đoạn văn về tầm quan trọng của việc đọc sách.", "Công thức làm món phở bò?"],
        en: ["Tell me a joke", "What is the capital of France?", "Write a paragraph about the importance of reading books.", "What is the recipe for beef pho?"],
        zh: ["讲个笑话", "法国的首都是哪里？", "写一段关于阅读重要性的段落。", "牛肉河粉的食谱是什么？"],
        hi: ["एक चुटकुला सुनाओ", "फ्रांस की राजधानी क्या है?", "किताबें पढ़ने के महत्व पर एक पैराग्राफ लिखें।", "बीफ फो की रेसिपी क्या है?"],
        es: ["Cuéntame un chiste", "¿Cuál es la capital de Francia?", "Escribe un párrafo sobre la importancia de leer libros.", "¿Cuál es la receta del pho de ternera?"],
        fr: ["Raconte-moi une blague", "Quelle est la capitale de la France ?", "Écrivez un paragraphe sur l'importance de la lecture.", "Quelle est la recette du phở au bœuf ?"],
        ja: ["冗談を言って", "フランスの首都はどこですか？", "読書の重要性について段落を書いてください。", "牛肉フォーのレシピは何ですか？"],
        it: ["Raccontami una barzelletta", "Qual è la capitale della Francia?", "Scrivi un paragrafo sull'importanza di leggere libri.", "Qual è la ricetta per il pho di manzo?"]
    };

    randomPromptBtn.addEventListener('click', () => {
        if (isRandomPromptUsedInSession) return;
        const prompts = randomPrompts[currentLang];
        const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];
        messageInput.value = randomPrompt;
        messageInput.dispatchEvent(new Event('input')); 
        isRandomPromptUsedInSession = true;
        updateRandomButtonVisibility();
        chatForm.dispatchEvent(new Event('submit', { cancelable: true }));
    });

    videoBtn.addEventListener('click', () => alert(translations[currentLang].comingSoon));
    
    function updateLearnButtonVisualState() {
        const learnIcon = learnBtn.querySelector('svg');
        const currentTheme = localStorage.getItem('theme') || 'dark';
        const activeColorClass = currentTheme === 'light' ? 'bg-blue-500' : 'bg-blue-600';
        
        if (isTutorMode) {
            learnBtn.classList.add(activeColorClass);
            learnIcon.classList.add('text-white');
            learnIcon.classList.remove(themeColors[currentTheme].iconColor);
        } else {
            learnBtn.classList.remove('bg-blue-600', 'bg-blue-500');
            learnIcon.classList.remove('text-white');
            learnIcon.classList.add(themeColors[currentTheme].iconColor);
        }
    }

    learnBtn.addEventListener('click', () => {
        isTutorMode = !isTutorMode; 
        localStorage.setItem('isTutorMode', isTutorMode);
        updateLearnButtonVisualState();
    });

    function updateModelButtonText() {
        const t = translations[currentLang];
        if (currentModel && currentModel.model) {
            textElements.modelBtnText.textContent = currentModel.model;
        } else {
             textElements.modelBtnText.textContent = t.modelButtonDefault;
        }
    }

    const createModelButton = (text, description, model, version = '', iconSvg) => {
        const theme = localStorage.getItem('theme') || 'dark';
        const themeConfig = themeColors[theme];
        const button = document.createElement('button');
        button.className = 'w-full text-left p-2 rounded-lg transition-colors duration-200 flex items-center justify-between btn-interaction';
        button.classList.add(...themeConfig.popupButton);
        button.dataset.model = model;
        if (version) button.dataset.version = version;
        const leftContainer = document.createElement('div');
        leftContainer.className = 'flex items-center gap-3';
        const iconContainer = document.createElement('div');
        iconContainer.innerHTML = iconSvg;
        leftContainer.appendChild(iconContainer);
        const textContainer = document.createElement('div');
        textContainer.className = 'flex flex-col';
        const nameSpan = document.createElement('span');
        nameSpan.className = 'font-semibold leading-tight';
        nameSpan.textContent = text;
        textContainer.appendChild(nameSpan);
        const descSpan = document.createElement('span');
        const descColor = theme === 'light' ? 'text-gray-500' : 'text-gray-400';
        descSpan.className = `text-xs ${descColor} leading-tight`;
        descSpan.textContent = description;
        textContainer.appendChild(descSpan);
        leftContainer.appendChild(textContainer);
        button.appendChild(leftContainer);
        const checkmarkContainer = document.createElement('div');
        checkmarkContainer.innerHTML = `<svg class="w-5 h-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>`;
        if (!(currentModel && currentModel.model === model && (!version || currentModel.version === version))) {
            checkmarkContainer.classList.add('hidden');
        }
        button.appendChild(checkmarkContainer);
        return button;
    };

    const showInitialModels = () => {
        modelPopup.innerHTML = '';
        const t = translations[currentLang];
        const iconThunder = `<svg class="w-6 h-6 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>`;
        const iconLightbulb = `<svg class="w-6 h-6 text-amber-300" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.311a7.5 7.5 0 01-7.5 0c-1.255 0-2.443-.29-3.5-.832a7.5 7.5 0 0114.5.032c-.318.13-.644.242-.984.326a7.5 7.5 0 01-4.016.033z" /></svg>`;
        const iconBrain = `<svg class="w-6 h-6 text-pink-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456z" /></svg>`;
        const models = [
            { text: 'Mini', description: t.modelMiniDesc, model: 'Mini', version: '', icon: iconThunder },
            { text: 'Smart', description: t.modelSmartDesc, model: 'Smart', version: '', icon: iconLightbulb },
            { text: 'Nerd', description: t.modelNerdDesc, model: 'Nerd', version: '', icon: iconBrain },
        ];
        models.forEach(m => {
            const btn = createModelButton(m.text, m.description, m.model, m.version, m.icon);
            btn.addEventListener('click', selectModelAndClose);
            modelPopup.appendChild(btn);
        });
    };

    const selectModelAndClose = (e) => {
        e.stopPropagation();
        const button = e.currentTarget;
        currentModel = {
            model: button.dataset.model,
            version: button.dataset.version || null
        };
        localStorage.setItem('currentModel', JSON.stringify(currentModel));
        updateModelButtonText();
        modelPopup.classList.add('hidden');
    };

    modelButton.addEventListener('click', (e) => {
        e.stopPropagation();
        showInitialModels();
        modelPopup.classList.toggle('hidden');
    });

    document.addEventListener('click', (e) => {
        if (!modelButton.contains(e.target) && !modelPopup.contains(e.target)) {
            modelPopup.classList.add('hidden');
        }
    });

    langSwitchBtn.addEventListener('click', () => showModal(languageModal, true));
    closeLanguageModalBtn.addEventListener('click', () => showModal(languageModal, false));
    languageModal.addEventListener('click', (e) => {
        if (e.target === languageModal) showModal(languageModal, false);
    });

    languageOptionButtons.forEach(button => {
        button.addEventListener('click', () => {
            const lang = button.getAttribute('data-lang');
            switchLanguage(lang);
            showModal(languageModal, false);
        });
    });

    function formatAIResponse(text) {
        let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        formattedText = formattedText.replace(/\n/g, '<br>');
        return formattedText;
    }

    function createMessageElement(messageContent, sender) {
        const row = document.createElement('div');
        row.classList.add('flex', 'w-full', 'mb-4');
        const messageWrapper = document.createElement('div');
        const currentTheme = localStorage.getItem('theme') || 'dark';
        const themeConfig = themeColors[currentTheme];
        if (sender === 'user') {
            row.classList.add('justify-end', 'user-message');
            messageWrapper.classList.add('user-message-wrapper', 'animate-pop-in', 'px-5', 'py-3', 'rounded-3xl', 'max-w-4xl', 'shadow-md', 'flex', 'flex-col', 'gap-2');
            messageWrapper.classList.add(...themeConfig.userMessage);
            if (Array.isArray(messageContent)) {
                messageContent.forEach(part => {
                    if (part.type === 'image_url') {
                        const img = document.createElement('img');
                        img.src = part.image_url.url;
                        img.className = 'rounded-lg max-w-xs';
                        messageWrapper.appendChild(img);
                    } else if (part.type === 'video_url') {
                        const video = document.createElement('video');
                        video.src = part.video_url.url;
                        video.className = 'rounded-lg max-w-xs';
                        video.controls = true;
                        messageWrapper.appendChild(video);
                    } else if (part.type === 'text') {
                        const textDiv = document.createElement('div');
                        textDiv.innerHTML = part.text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        messageWrapper.appendChild(textDiv);
                    }
                });
            } else {
                 messageWrapper.innerHTML = messageContent.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            }
        } else {
            row.classList.add('justify-start');
            messageWrapper.classList.add('ai-message-wrapper', 'animate-pop-in', 'max-w-4xl');
            messageWrapper.classList.add(...themeConfig.aiMessage);
            messageWrapper.innerHTML = formatAIResponse(messageContent);
        }
        row.appendChild(messageWrapper);
        return row;
    }
    
    const systemPrompts = {
        vi: {
            tutor: "Bạn là một gia sư AI thân thiện và kiên nhẫn tên là Oceep. Mục tiêu của bạn là dạy và giải thích các khái niệm phức tạp một cách đơn giản. Luôn trả lời súc tích và đi thẳng vào vấn đề, nhưng vẫn đảm bảo giải thích đầy đủ và dễ hiểu. Luôn trả lời bằng tiếng Việt. Nếu người dùng viết bằng ngôn ngữ khác, hãy lịch sự thông báo rằng bạn chỉ có thể giao tiếp bằng Tiếng Việt. Sử dụng định dạng LaTeX với \\( ... \\) cho toán học.",
            assistant: `Bạn là Oceep của FoxAI, một trợ lý AI thân thiện. Luôn trả lời ngắn gọn, súc tích và đi thẳng vào vấn đề. Chỉ cung cấp câu trả lời dài khi được yêu cầu hoặc khi cần thiết. Luôn trả lời bằng tiếng Việt. Nếu người dùng viết bằng ngôn ngữ khác ngoài Tiếng Việt, hãy lịch sự thông báo rằng bạn chỉ có thể giao tiếp bằng Tiếng Việt và yêu cầu họ diễn đạt lại câu hỏi. Sử dụng định dạng LaTeX với \\( ... \\) cho toán học.`
        },
        en: {
            tutor: "You are a friendly and patient AI tutor named Oceep. Your goal is to teach and explain complex concepts simply. Always answer concisely and to the point, but still ensure your explanations are thorough and easy to understand. Always respond in English. If the user writes in another language, politely inform them that you can only communicate in English. Use LaTeX format with \\( ... \\) for mathematics.",
            assistant: "You are Oceep by FoxAI, a friendly AI assistant. Always answer briefly, concisely, and to the point. Only provide long answers when asked or when necessary. Always respond in English. If the user writes in a language other than English, politely inform them that you can only communicate in English and ask them to rephrase the question. Use LaTeX format with \\( ... \\) for mathematics."
        },
        ja: {
            tutor: "あなたはOceepという名前の、フレンドリーで忍耐強いAI家庭教師です。あなたの目標は、複雑な概念を簡単に教え、説明することです。常に簡潔で要点を押さえた回答を心がけ、それでも十分に理解しやすい説明を提供してください。常に日本語で回答してください。ユーザーが他の言語で書いた場合は、日本語でのみコミュニケーションできることを丁寧に伝え、質問を言い換えるよう依頼してください。数学には \\( ... \\) を使ったLaTeX形式を使用してください。",
            assistant: "あなたはFoxAIのOceep、フレンドリーなAIアシスタントです。常に短く、簡潔で、要点を押さえた回答をしてください。要求された場合や必要な場合にのみ長い回答を提供してください。常に日本語で回答してください。ユーザーが日本語以外の言語で書いた場合は、日本語でのみコミュニケーションできることを丁寧に伝え、質問を言い換えるよう依頼してください。数学には \\( ... \\) を使ったLaTeX形式を使用してください。"
        },
        it: {
            tutor: "Sei Oceep, un tutor AI amichevole e paziente. Il tuo obiettivo è insegnare e spiegare concetti complessi in modo semplice. Rispondi sempre in modo conciso e diretto, ma assicurati che le tue spiegazioni siano complete e facili da capire. Rispondi sempre in italiano. Se l'utente scrive in un'altra lingua, informalo gentilmente che puoi comunicare solo in italiano e chiedigli di riformulare la domanda. Usa il formato LaTeX con \\( ... \\) per la matematica.",
            assistant: "Sei Oceep di FoxAI, un amichevole assistente AI. Rispondi sempre in modo breve, conciso e diretto. Fornisci risposte lunghe solo se richiesto o necessario. Rispondi sempre in italiano. Se l'utente scrive in una lingua diversa dall'italiano, informalo gentilmente che puoi comunicare solo in italiano e chiedigli di riformulare la domanda. Usa il formato LaTeX con \\( ... \\) per la matematica."
        }
    };

    async function streamAIResponse(modelName, messages, aiMessageEl, signal) {
        const config = apiConfig[modelName];
        if (!config) throw new Error(`Configuration for model '${modelName}' not found.`);
        const langPrompts = systemPrompts[currentLang] || systemPrompts['en'];
        const systemContent = isTutorMode ? langPrompts.tutor : langPrompts.assistant;
        const systemMessage = { role: 'system', content: systemContent };
        const messagesWithSystemPrompt = [systemMessage, ...messages];
        const API_URL = 'https://openrouter.ai/api/v1/chat/completions';

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.key}`, 'HTTP-Referer': 'http://localhost:3000', 'X-Title': 'oceep Chatbot' },
                body: JSON.stringify({ model: config.model, messages: messagesWithSystemPrompt, stream: true }),
                signal
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || 'Unknown error from API.');
            }
            const reader = response.body.getReader();
            const decoder = new TextDecoder('utf-8');
            let fullResponseText = "";
            let buffer = '';
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                const parts = buffer.split('\n\n');
                buffer = parts.pop();
                for (const part of parts) {
                    if (part.startsWith('data:')) {
                        const jsonString = part.substring(5).trim();
                        if (jsonString === '[DONE]') break;
                        try {
                            const data = JSON.parse(jsonString);
                            const content = data.choices[0].delta.content;
                            if (content) {
                                fullResponseText += content;
                                aiMessageEl.firstChild.innerHTML = formatAIResponse(fullResponseText);
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            }
                        } catch (e) {
                            console.error("Error parsing stream chunk:", e, jsonString);
                        }
                    }
                }
            }
            return fullResponseText;
        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('Stream stopped by user.');
                return aiMessageEl.firstChild.innerText;
            }
            console.error("Error calling OpenRouter API:", error);
            throw error;
        }
    }

    stopButton.addEventListener('click', () => {
        if (abortController) abortController.abort();
    });

    // --- NEW HELPER FUNCTION TO TOGGLE INPUT STATE ---
    function setInputActive(isActive) {
        const t = translations[currentLang];
        messageInput.disabled = !isActive;
        
        // Disable/Enable all buttons in the footer
        const footerButtons = [
            randomPromptBtn, videoBtn, learnBtn, uploadFileBtn, modelButton
        ];
        footerButtons.forEach(btn => btn.disabled = !isActive);

        if (isActive) {
            // When activating, restore the correct placeholder based on token count
            updateTokenUI();
        } else {
            // When deactivating, show the typing placeholder
            messageInput.placeholder = t.aiTypingPlaceholder;
        }
    }


    chatForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        const message = messageInput.value.trim();
        if (!message && !stagedFile) return;

        if (!consumeToken()) {
            console.log("No tokens left to send message.");
            return;
        }

        if (!initialView.classList.contains('hidden')) {
            initialView.style.opacity = '0';
            setTimeout(() => {
                initialView.classList.add('hidden');
                chatContainer.classList.remove('hidden');
                mainContent.classList.remove('justify-center');
                mainContent.classList.add('justify-start');
            }, 500);
        }

        const userMessageContent = [];
        if (stagedFile) {
            if (stagedFile.type === 'image') {
                userMessageContent.push({ type: "image_url", image_url: { url: stagedFile.url } });
            } else if (stagedFile.type === 'video') {
                userMessageContent.push({ type: "video_url", video_url: { url: stagedFile.url } });
            }
        }
        if (message) userMessageContent.push({ type: "text", text: message });

        const userMessageEl = createMessageElement(userMessageContent, 'user');
        chatContainer.appendChild(userMessageEl);

        const historyContent = userMessageContent.length === 1 && userMessageContent[0].type === 'text'
            ? message
            : userMessageContent;
        conversationHistory.push({ role: 'user', content: historyContent });
        renderHistoryList(); // Update history immediately

        messageInput.value = '';
        messageInput.dispatchEvent(new Event('input')); 
        stagedFile = null;
        fileThumbnailContainer.innerHTML = '';
        isRandomPromptUsedInSession = true; 
        updateRandomButtonVisibility(); 
        chatContainer.scrollTop = chatContainer.scrollHeight;

        const aiMessageEl = createMessageElement('', 'ai');
        aiMessageEl.firstChild.classList.add('streaming');
        chatContainer.appendChild(aiMessageEl);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        sendButton.classList.add('hidden');
        soundWaveButton.classList.add('hidden');
        stopButton.classList.remove('hidden');
        
        // --- MODIFICATION: Deactivate input form ---
        setInputActive(false);

        abortController = new AbortController();

        try {
            const modelToUse = (currentModel && currentModel.model) ? currentModel.model : 'Mini';
            const fullAiResponse = await streamAIResponse(modelToUse, conversationHistory, aiMessageEl, abortController.signal);
            conversationHistory.push({ role: 'assistant', content: fullAiResponse });
            chatContainer.scrollTop = chatContainer.scrollHeight;
            saveStateToLocalStorage(); 
        } catch (error) {
            aiMessageEl.remove();
            const errorMessage = `${translations[currentLang].errorPrefix}: ${error.message}`;
            const errorMessageEl = createMessageElement(errorMessage, 'ai');
            errorMessageEl.firstChild.classList.add('!bg-red-500', 'text-white');
            chatContainer.appendChild(errorMessageEl);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        } finally {
            aiMessageEl.firstChild.classList.remove('streaming');
            if (window.MathJax) MathJax.typesetPromise([aiMessageEl]);

            stopButton.classList.add('hidden');
            soundWaveButton.classList.remove('hidden');
            
            // --- MODIFICATION: Reactivate input form ---
            setInputActive(true);
            // updateTokenUI() is called inside setInputActive(true)
        }
    });
    
    uploadFileBtn.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        // Clear previous preview and release object URL if it exists
        if (stagedFile && stagedFile.type === 'video') {
            URL.revokeObjectURL(stagedFile.url);
        }
        stagedFile = null;
        fileThumbnailContainer.innerHTML = '';
        
        const removeButtonHTML = `<button id="remove-file-btn" class="absolute top-0 right-0 -mt-2 -mr-2 bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center font-bold text-xs btn-interaction">&times;</button>`;

        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                stagedFile = { file: file, url: e.target.result, type: 'image' };
                fileThumbnailContainer.innerHTML = `
                    <div class="relative inline-block">
                        <img src="${stagedFile.url}" class="h-20 w-auto rounded-lg" />
                        ${removeButtonHTML}
                    </div>
                `;
                addRemoveButtonListener();
            };
            reader.readAsDataURL(file);
        } else if (file.type.startsWith('video/')) {
            const objectURL = URL.createObjectURL(file);
            stagedFile = { file: file, url: objectURL, type: 'video' };
            fileThumbnailContainer.innerHTML = `
                <div class="relative inline-block">
                    <video src="${stagedFile.url}" class="h-20 w-auto rounded-lg" autoplay muted loop playsinline></video>
                    ${removeButtonHTML}
                </div>
            `;
            addRemoveButtonListener();
        }
    });

    function addRemoveButtonListener() {
        document.getElementById('remove-file-btn').addEventListener('click', () => {
            if (stagedFile && stagedFile.type === 'video') {
                 URL.revokeObjectURL(stagedFile.url); // Clean up video object URL
            }
            stagedFile = null;
            fileThumbnailContainer.innerHTML = '';
            fileInput.value = ''; // Reset file input
        });
    }

</script>

</body>

</html>
